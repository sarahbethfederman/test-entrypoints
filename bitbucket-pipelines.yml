image: node:latest

clone:
  depth: 50 # debugging

pipelines:
  default:

    - parallel:

      - step:
          name: âœ… Lint
          script:
            - ./ci/lint.sh
          caches:
            - nodemonorepo

      - step:
          name: âš’ Build
          script:
            - ./ci/build.sh
          caches:
            - nodemonorepo
          artifacts:
            - "**/dist/**"

      - step:
          name: ğŸ“ Test (react@^16)
          script:
            - ./ci/test.sh
          caches:
            - nodemonorepo

      - step:
          name: ğŸ“ Test (react@^15)
          script:
            - ./ci/test-react-15.sh
          caches:
            - nodemonorepo

    - step:
        name: ğŸš€ Deploy
        script:
          - ./ci/deploy.sh
        caches:
          - nodemonorepo

  branches:
    master:

      - parallel:

        - step:
            name: âœ… Lint
            script:
              - ./ci/lint.sh
            caches:
              - nodemonorepo

        - step:
            name: âš’ Build
            script:
              - ./ci/build.sh
            caches:
              - nodemonorepo
            artifacts:
              - "**/dist/**"

        - step:
            name: ğŸ“ Test (react@^16)
            script:
              - ./ci/test.sh
            caches:
              - nodemonorepo

        - step:
            name: ğŸ“ Test (react@^15)
            script:
              - ./ci/test-react-15.sh
            caches:
              - nodemonorepo

      - step:
          name: ğŸš€ Deploy
          deployment: production
          script:
            - ./ci/deploy.sh
          caches:
            - nodemonorepo

      - step:
          name: ğŸ“¦ Publish
          script:
            - ./ci/publish.sh
          caches:
            - nodemonorepo

definitions:
  caches:
    nodemonorepo: "**/node_modules/**"
