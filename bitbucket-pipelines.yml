image: node:12.18.3

clone:
  depth: full

definitions:
  services:
    docker:
      memory: 8192

pipelines:
  default:
    - parallel:
        - step:
            name: Deduplicate
            script:
              - ./ci/deduplicate.sh
            caches:
              - node
        - step:
            name: 🔎 Check
            script:
              - ./ci/check.sh
            caches:
              - node
        - step:
            name: ✅ Lint
            script:
              - ./ci/lint.sh
            caches:
              - node

        - step:
            name: ⚒ Build all packages
            size: 2x
            script:
              - export NODE_OPTIONS=--max-old-space-size=8192
              - ./ci/build.sh
            caches:
              - node
            artifacts:
              - '**/dist/**'

    - step:
        name: ⚒ Build LUI website
        script:
          - ./ci/build-lui-website.sh development
        caches:
          - node
        artifacts:
          - 'website/dist/**'

    - step:
        name: 🚀 Deploy LUI website
        script:
          - ./ci/deploy-lui-website.sh development
        caches:
          - node

    - step:
        name: 📝 Test
        script:
          - ./ci/test.sh
        caches:
          - node

  branches:
    master:
      - parallel:
          - step:
              name: Deduplicate
              script:
                - ./ci/deduplicate.sh
              caches:
                - node
          - step:
              name: 🔎 Check
              script:
                - ./ci/check.sh
              caches:
                - node
          - step:
              name: ✅ Lint
              script:
                - ./ci/lint.sh
              caches:
                - node
          - step:
              name: ⚒ Build all packages
              script:
                - ./ci/build.sh
              caches:
                - node
              artifacts:
                - '**/dist/**'
      - step:
          name: ⚒ Build LUI website
          script:
            - ./ci/build-lui-website.sh production
          caches:
            - node
          artifacts:
            - 'website/dist/**'
      - step:
          name: 🚀 Deploy LUI website
          deployment: production
          script:
            - ./ci/deploy-lui-website.sh production
          caches:
            - node
      - step:
          name: 📝 Test
          script:
            - ./ci/test.sh
          caches:
            - node
      - step:
          name: 📦 Publish
          size: 2x
          script:
            - ./ci/publish.sh
          caches:
            - node

