image: node:10.15.0

clone:
  depth: full

pipelines:
  default:
    - parallel:
      - step:
          name: Deduplicate
          script:
            - ./ci/deduplicate.sh
          caches:
            - node
      - step:
          name: 🔎 Check
          script:
            - ./ci/check.sh
          caches:
            - node
      - step:
          name: ✅ Lint
          script:
            - ./ci/lint.sh
          caches:
            - node

      - step:
          name: ⚒ Build
          script:
            - ./ci/build.sh
          caches:
            - node
          artifacts:
            - "**/dist/**"

      - step:
          name: 📝 Test (react@^16)
          script:
            - ./ci/test.sh
          caches:
            - node

      - step:
          name: 📝 Test (react@^15)
          script:
            - ./ci/test-react-15.sh
          caches:
            - node

    - step:
        name: 🚀 Deploy
        script:
          - ./ci/deploy.sh
        caches:
          - node

  branches:
    master:
      - parallel:
        - step:
            name: Deduplicate
            script:
              - ./ci/deduplicate.sh
            caches:
              - node
        - step:
            name: 🔎 Check
            script:
              - ./ci/check.sh
            caches:
              - node
        - step:
            name: ✅ Lint
            script:
              - ./ci/lint.sh
            caches:
              - node

        - step:
            name: ⚒ Build
            script:
              - ./ci/build.sh
            caches:
              - node
            artifacts:
              - "**/dist/**"

        - step:
            name: 📝 Test (react@^16)
            script:
              - ./ci/test.sh
            caches:
              - node

        - step:
            name: 📝 Test (react@^15)
            script:
              - ./ci/test-react-15.sh
            caches:
              - node

      - step:
          name: 🚀 Deploy
          deployment: production
          script:
            - ./ci/deploy.sh
          caches:
            - node

      - step:
          name: 📦 Publish
          script:
            - ./ci/publish.sh
          caches:
            - node
